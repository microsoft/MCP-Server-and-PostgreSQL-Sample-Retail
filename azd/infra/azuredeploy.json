{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Complete ARM template for MCP Retail Analytics infrastructure including Azure AI Foundry, OpenAI models, and Application Insights"
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location into which all resources will be deployed."
      },
      "defaultValue": "westus2",
      "allowedValues": ["eastus", "eastus2", "westus", "westus2", "centralus", "northcentralus", "southcentralus", "westcentralus", "swedencentral"]
    },
    "uniqueSuffix": {
      "type": "string",
      "metadata": {
        "description": "A short unique suffix to append to all resource names (no spaces, e.g. '001' or 'contoso')."
      },
      "defaultValue": "[substring(uniqueString(subscription().subscriptionId), 0, 4)]"
    },
    "aiProjectFriendlyName": {
      "type": "string",
      "defaultValue": "MCP Retail Analytics Project",
      "metadata": {
        "description": "Friendly name for your Azure AI resource"
      }
    },
    "aiProjectDescription": {
      "type": "string",
      "defaultValue": "MCP Server for Retail Sales Analysis with PostgreSQL integration",
      "metadata": {
        "description": "Description of your Azure AI resource displayed in Azure AI Foundry"
      }
    },
    "gptModelCapacity": {
      "type": "int",
      "defaultValue": 150,
      "metadata": {
        "description": "Capacity for the GPT model deployment"
      }
    },
    "embeddingModelCapacity": {
      "type": "int",
      "defaultValue": 50,
      "metadata": {
        "description": "Capacity for the text-embedding-3-small model deployment"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "source": "Azure Developer CLI - MCP Retail Sample",
        "environment": "development",
        "project": "mcp-retail-analytics"
      },
      "metadata": {
        "description": "Set of tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourceGroupName": "rg-mcpretail-demo001",
    "accountName": "[concat('aifoundry-', parameters('uniqueSuffix'))]",
    "projectName": "[concat('project-', parameters('uniqueSuffix'))]",
    "gptDeploymentName": "[concat('gpt-4o-mini-', parameters('uniqueSuffix'))]",
    "textEmbeddingDeploymentName": "[concat('text-embedding-3-small-', parameters('uniqueSuffix'))]",
    "applicationInsightsName": "[concat('appi-mcpretail-', parameters('uniqueSuffix'))]",
    "logAnalyticsWorkspaceName": "[concat('law-mcpretail-', parameters('uniqueSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2018-05-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": {},
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "infrastructure-deployment",
      "resourceGroup": "rg-mcpretail-demo001",
      "dependsOn": [
        "rg-mcpretail-demo001"
      ],
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "accountName": "[concat('aifoundry-', uniqueString(resourceGroup().id))]",
            "projectName": "[concat('project-', uniqueString(resourceGroup().id))]",
            "gptDeploymentName": "[concat('gpt-4o-mini-', uniqueString(resourceGroup().id))]",
            "textEmbeddingDeploymentName": "[concat('text-embedding-3-small-', uniqueString(resourceGroup().id))]",
            "applicationInsightsName": "[concat('appi-mcpretail-', uniqueString(resourceGroup().id))]",
            "logAnalyticsWorkspaceName": "[concat('law-mcpretail-', uniqueString(resourceGroup().id))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1,
                  "legacy": 0,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
              ],
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[variables('accountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "S0"
              },
              "kind": "AIServices",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "customSubDomainName": "[variables('accountName')]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "allowProjectManagement": true,
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": false
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-06-01",
              "name": "[concat(variables('accountName'), '/', variables('projectName'))]",
              "location": "[parameters('location')]",
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
              ],
              "kind": "AIServices",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {},
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-06-01",
              "name": "[concat(variables('accountName'), '/', variables('gptDeploymentName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
              ],
              "sku": {
                "name": "GlobalStandard",
                "capacity": "[parameters('gptModelCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4o-mini",
                  "version": "2024-07-18"
                },
                "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
                "currentCapacity": "[parameters('gptModelCapacity')]",
                "raiPolicyName": "Microsoft.DefaultV2"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-06-01",
              "name": "[concat(variables('accountName'), '/', variables('textEmbeddingDeploymentName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('accountName'), variables('gptDeploymentName'))]"
              ],
              "sku": {
                "name": "GlobalStandard",
                "capacity": "[parameters('embeddingModelCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-3-small",
                  "version": "1"
                },
                "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
                "currentCapacity": "[parameters('embeddingModelCapacity')]",
                "raiPolicyName": "Microsoft.DefaultV2"
              }
            }
          ],
          "outputs": {
            "accountResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
            },
            "projectResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', variables('accountName'), variables('projectName'))]"
            },
            "foundryAccountName": {
              "type": "string",
              "value": "[variables('accountName')]"
            },
            "foundryAccountKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '2025-06-01').key1]"
            },
            "foundryEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))).endpoint]"
            },
            "gptDeploymentName": {
              "type": "string",
              "value": "[variables('gptDeploymentName')]"
            },
            "embeddingDeploymentName": {
              "type": "string",
              "value": "[variables('textEmbeddingDeploymentName')]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).ConnectionString]"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "aiFoundryName": {
      "type": "string",
      "value": "[variables('accountName')]"
    },
    "aiProjectName": {
      "type": "string",
      "value": "[variables('projectName')]"
    },
    "accountResourceId": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.accountResourceId.value]"
    },
    "projectResourceId": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.projectResourceId.value]"
    },
    "foundryEndpoint": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.foundryEndpoint.value]"
    },
    "foundryAccountKey": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.foundryAccountKey.value]"
    },
    "deployedModels": {
      "type": "array",
      "value": [
        {
          "name": "gpt-4o-mini",
          "deploymentName": "[reference('infrastructure-deployment').outputs.gptDeploymentName.value]"
        },
        {
          "name": "text-embedding-3-small",
          "deploymentName": "[reference('infrastructure-deployment').outputs.embeddingDeploymentName.value]"
        }
      ]
    },
    "applicationInsightsName": {
      "type": "string",
      "value": "[variables('applicationInsightsName')]"
    },
    "applicationInsightsConnectionString": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.applicationInsightsConnectionString.value]"
    },
    "applicationInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference('infrastructure-deployment').outputs.applicationInsightsInstrumentationKey.value]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "value": "[variables('logAnalyticsWorkspaceName')]"
    }
  }
}
